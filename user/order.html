<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>TechSphere - Order History</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
			rel="stylesheet"
		/>
	</head>
	<body class="bg-gray-50 text-gray-900 font-sans">
		<!-- Navigation (keep your existing navigation) -->
		<nav class="fixed w-full top-0 z-50 bg-white shadow-sm">
			<!-- Your existing navigation HTML -->
		</nav>

		<!-- Order History Section -->
		<div class="container mx-auto px-6 pt-24">
			<div class="flex justify-between items-center mb-8">
				<h1 class="text-4xl font-bold text-blue-600">Order History</h1>
				<div class="flex items-center space-x-4">
					<input
						type="text"
						id="searchOrder"
						placeholder="Search Orders"
						class="border border-gray-300 rounded-md px-3 py-2 w-64"
					/>
				</div>
			</div>

			<!-- Loading Indicator -->
			<div
				id="loadingIndicator"
				class="flex justify-center items-center py-12 hidden"
			>
				<div
					class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600"
				></div>
			</div>

			<!-- Order List -->
			<div id="orderListContainer" class="space-y-6">
				<!-- Orders will be dynamically inserted here -->
			</div>

			<!-- No Orders Placeholder -->
			<div id="noOrdersPlaceholder" class="hidden text-center py-12">
				<i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
				<h2 class="text-2xl font-semibold text-gray-600">No Orders Yet</h2>
				<p class="text-gray-500 mt-2">
					Start shopping to see your order history.
				</p>
				<a
					href="products.html"
					class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700"
				>
					Shop Now
				</a>
			</div>
		</div>

		<!-- Order Details Modal -->
		<div
			id="orderDetailsModal"
			class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
		>
			<div
				class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 relative"
			>
				<button
					id="closeOrderModal"
					class="absolute top-4 right-4 text-gray-600 hover:text-gray-900"
				>
					<i class="fas fa-times text-2xl"></i>
				</button>

				<div id="orderModalContent">
					<!-- Dynamic order details will be inserted here -->
				</div>
			</div>
		</div>

		<script>
			class OrderManager {
				constructor() {
					this.orderListContainer =
						document.getElementById("orderListContainer");
					this.orderDetailsModal = document.getElementById("orderDetailsModal");
					this.orderModalContent = document.getElementById("orderModalContent");
					this.searchOrder = document.getElementById("searchOrder");
					this.loadingIndicator = document.getElementById("loadingIndicator");
					this.noOrdersPlaceholder = document.getElementById(
						"noOrdersPlaceholder"
					);

					this.orders = []; // Will store fetched orders
					this.initEventListeners();
					this.fetchOrders();
				}

				initEventListeners() {
					// Search orders
					this.searchOrder.addEventListener("input", () => this.renderOrders());

					// Close modal
					document
						.getElementById("closeOrderModal")
						.addEventListener("click", () => {
							this.orderDetailsModal.classList.add("hidden");
						});

					// Close modal when clicking outside
					this.orderDetailsModal.addEventListener("click", (e) => {
						if (e.target === this.orderDetailsModal) {
							this.orderDetailsModal.classList.add("hidden");
						}
					});
				}

				async fetchOrders() {
					// Show loading indicator
					this.loadingIndicator.classList.remove("hidden");
					this.orderListContainer.innerHTML = "";
					this.noOrdersPlaceholder.classList.add("hidden");

					try {
						const userId = localStorage.getItem("userId");
						if (!userId) {
							throw new Error("User not logged in");
						}

						// Update this line to use full backend URL
						const response = await fetch(
							`http://localhost:3000/api/orders?userId=${userId}`,
							{
								method: "GET",
								headers: {
									"Content-Type": "application/json",
								},
							}
						);

						if (!response.ok) {
							// Log the error response
							const errorBody = await response.text();
							console.error("Error response:", errorBody);
							throw new Error("Failed to fetch orders");
						}

						this.orders = await response.json();

						// Hide loading indicator
						this.loadingIndicator.classList.add("hidden");

						this.renderOrders();
					} catch (error) {
						console.error("Error fetching orders:", error);

						// Hide loading indicator
						this.loadingIndicator.classList.add("hidden");

						// Show error message or handle accordingly
						this.showErrorState(error.message);
					}
				}
				showErrorState(message) {
					this.orderListContainer.innerHTML = `
                <div class="text-center py-12 bg-red-50 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-semibold text-red-600">Error</h2>
                    <p class="text-red-500 mt-2">${message}</p>
                    <button onclick="window.location.reload()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700">
                        Try Again
                    </button>
                </div>
            `;
				}

				renderOrders() {
					const searchValue = this.searchOrder.value.toLowerCase();
					this.orderListContainer.innerHTML = "";

					const filteredOrders = this.orders.filter((order) => {
						return order.id.toLowerCase().includes(searchValue);
					});

					// Show no orders placeholder if no orders or no filtered orders
					if (this.orders.length === 0) {
						this.noOrdersPlaceholder.classList.remove("hidden");
						return;
					}

					if (filteredOrders.length === 0) {
						this.orderListContainer.innerHTML = `
                    <div class="text-center py-12 bg-gray-100 rounded-lg">
                        <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">No orders match your search</p>
                    </div>
                `;
						return;
					}

					filteredOrders.forEach((order) => this.renderOrderItem(order));
				}

				renderOrderItem(order) {
					const orderItemElement = document.createElement("div");
					orderItemElement.classList.add(
						"bg-white",
						"border",
						"border-gray-200",
						"rounded-xl",
						"p-6",
						"flex",
						"justify-between",
						"items-center"
					);
					orderItemElement.innerHTML = `
                <div>
                    <h2 class="text-xl font-bold">Order ID: ${order.id}</h2>
                    <p class="text-gray-600">Date: ${order.date}</p>
                </div>
                <div>
                    <span class="text-lg font-bold">$${order.total.toFixed(
											2
										)}</span>
                    <button class="mt-2 text-blue-600 hover:underline view-details" data-id="${
											order.id
										}">View Details</button>
                </div>
            `;
					this.orderListContainer.appendChild(orderItemElement);

					// Add event listener for view details button
					orderItemElement
						.querySelector(".view-details")
						.addEventListener("click", () => {
							this.showOrderDetails(order);
						});
				}

				showOrderDetails(order) {
					this.orderModalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Order Details: ${
									order.id
								}</h2>
                <p class="text-gray-600 mb-2">Date: ${order.date}</p>
                <h3 class="text-xl font-bold mb-2">Items:</h3>
                <div class="space-y-4">
                    ${order.items
											.map(
												(item) => `
                        <div class="flex items-center space-x-4">
                            <img src="${
															item.image
														}" class="w-16 h-16 object-cover rounded-lg" />
                            <div>
                                <h4 class="text-lg font-bold">${item.name}</h4>
                                <p class="text-gray-600">Price: $${item.price.toFixed(
																	2
																)} x ${item.quantity}</p>
                            </div>
                        </div>
                    `
											)
											.join("")}
                </div>
                <h3 class="text-xl font-bold mt-4">Total: $${order.total.toFixed(
									2
								)}</h3>
            `;
					this.orderDetailsModal.classList.remove("hidden");
				}
			}

			// Initialize Order Manager
			new OrderManager();
		</script>
	</body>
</html>
